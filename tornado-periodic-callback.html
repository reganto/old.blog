<!DOCTYPE html>
<html lang="fa">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap');
            div.article-content p, div.article-content h1, div.article-content h2, div.article-content h3, div.article-content ul li, div.article-content ol li, header.page-header h1, div.recent-posts-article{
                direction: rtl;
                font-family: 'Vazirmatn', sans-serif;
            }
            div.recent-posts-posted {
                direction: ltr;
            }
            header.page-header h1{
                direction: rtl;
                font-family: 'Vazirmatn', sans-serif;
            }
        </style>
        <meta name="author" content="Reganto" />

        <meta name="description" content="Tornado Periodic Callback
" />
        <meta name="twitter:creator" content="@monaghizadeh">
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="python, tornado, Tornado, " />

<meta property="og:title" content="تورنادو و تسک‌های periodic "/>
<meta property="og:url" content="/tornado-periodic-callback.html" />
<meta property="og:description" content="Tornado Periodic Callback" />
<meta property="og:site_name" content="رگانتو" />
<meta property="og:article:author" content="Reganto" />
<meta property="og:article:published_time" content="2022-08-31T10:20:00+04:30" />
<meta property="og:article:modified_time" content="2010-12-05T19:30:00+03:30" />
<meta name="twitter:title" content="تورنادو و تسک‌های periodic ">
<meta name="twitter:description" content="Tornado Periodic Callback">

        <title>تورنادو و تسک‌های periodic  · رگانتو
</title>
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="رگانتو - Full Atom Feed" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="/"><span class=site-name>رگانتو</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       "/"
                                    >خانه</a>
                                </li>
                                <li ><a href="/categories.html">دسته‌بندی‌ها</a></li>
                                <li ><a href="/tags.html">تگ‌ها</a></li>
                                <li ><a href="/archives.html">آرشیو</a></li>
                                <!-- <li><form class="navbar-search" action="/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li> -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="/tornado-periodic-callback.html">
                تورنادو و تسک‌های periodic
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <h2>مقدمه</h2>
<p>یکی از ویژگی‌های بسیار جذاب تورنادو توانایی آن در اجرای تسک‌های پریودیک‌ است. ابزارهای دیگری نیز برای این دسته از تسک‌ها وجود دارند که شاید معروف‌ترین آن‌ها <code>Celery Beat</code> و <code>Crond</code> باشد اما تورنادو این کار را بدون هیچگونه پیش‌نیازی  و به سادگی و تنها با فراخوانی یک متد انجام می‌دهد.</p>
<h2>امضای متد</h2>
<p>متد مورد نظر برای اجرای تسک‌های پریودیک <code>PeriodicCallback</code> نام دارد آن را می‌توان از مسیر <code>tornado.ioloop.PeriodicCallback</code> ایمپورت کرد. این متد سه آرگومان می‌گیرد اولی تابعی است که قرار است اجرا شود «کال‌بک مورد نظر ما» دومی فاصله زمانی بین اجرای متوالی کال‌بک است«همان interval یا callback time» سومی هم پارامتری است به نام jitter</p>
<h2>یک مثال</h2>
<p>می‌خواهیم یک تابع داشته باشیم که در فواصل زمانی معین یک پیام را به خروجی می‌برد.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="kn">import</span> <span class="n">PeriodicCallback</span>


<span class="k">def</span> <span class="nf">say_hello</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello Tornado&quot;</span><span class="p">)</span>


<span class="n">callback</span> <span class="o">=</span> <span class="n">PeriodicCallback</span><span class="p">(</span><span class="n">say_hello</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
<span class="n">callback</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
</code></pre></div>

<p>تابع <code>say_hello</code> هر سه ثانیه یکبار به صورت پریودیک اجرا می‌شود. اکثر زمان‌ها در تورنادو به صورت ثانیه وارد می‌شود اما در این مورد یک استثنا وجود دارد. پارامتر <code>callback_time</code> در <code>PeriodicCallback</code> باید به صورت میلی‌ثانیه یا شی‌ای از <code>datetime.timedelta</code> وارد شود.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="kn">import</span> <span class="n">PeriodicCallback</span>


<span class="k">def</span> <span class="nf">say_hello</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello Tornado&quot;</span><span class="p">)</span>


<span class="n">callback</span> <span class="o">=</span> <span class="n">PeriodicCallback</span><span class="p">(</span><span class="n">say_hello</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="n">callback</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
</code></pre></div>

<h2>فراخوانی کال‌بک با آرگومان</h2>
<p>بعضی از توابع‌ برای اجرا نیازمند آرگومان‌هایی هستند و به دو روش می‌توان آرگومان‌هایی را به کال‌بک مورد نظر فرستاد</p>
<p>1- استفاده از <code>lambda</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="kn">import</span> <span class="n">PeriodicCallback</span>


<span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">callback</span> <span class="o">=</span> <span class="n">PeriodicCallback</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;Reganto&quot;</span><span class="p">),</span> <span class="mi">3000</span><span class="p">)</span>
<span class="n">callback</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
</code></pre></div>

<p>2- استفاده از <code>partial</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="kn">import</span> <span class="n">PeriodicCallback</span>


<span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hello </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">callback</span> <span class="o">=</span> <span class="n">PeriodicCallback</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">say_hello</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Reganto&quot;</span><span class="p">),</span> <span class="mi">3000</span><span class="p">)</span>
<span class="n">callback</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
</code></pre></div>

<h2>یک مثال ملموس‌تر</h2>
<p>سناریویی را در نظر بگیرید که در یک سیستم تعدادی کاربر داشته باشیم. کاربران مورد نظر ما برای دریافت سرویسی ماهانه مبلغی را پرداخت می‌کنند در این‌صورت تسکی باید به صورت ماهیانه اجرا شود. این تسک می‌بایست کاربرانی را که برای سرویس مورد نظر پرداختی نداشته‌اند پیدا کرده و دسترسی آن‌ها را به سرویس مسدود کند و درنهایت ایمیلی با متن مناسب برای کاربرانی که اکانت خود را شارژ نکرده‌اند بفرستد.</p>
<p>این تسک را می‌توان به سه زیرتسک «سه تابع» تقسیم کرد:</p>
<p>1- پیدا کردن کاربرانی که پرداختی نداشته‌اند</p>
<p>2- مسدود کردن دسترسی کاربرانی که پرداختی نداشته‌اند</p>
<p>3- ارسال ایمیل به کاربران مسدودشده و درخواست برای شارژ اکانت</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">from</span> <span class="nn">tornado.ioloop</span> <span class="kn">import</span> <span class="n">PeriodicCallback</span>

<span class="k">def</span> <span class="nf">scan_for_expired_users</span><span class="p">():</span>
    <span class="n">expired_users</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Finrod&quot;</span><span class="p">,</span> <span class="s2">&quot;Boromir&quot;</span><span class="p">,</span> <span class="s2">&quot;Theoden&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">expired_users</span>

<span class="k">def</span> <span class="nf">deactivating_process</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deactivating account: </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">send_expiration_email</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending expiration email to: </span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">arda_task</span><span class="p">():</span>
    <span class="n">expired_users</span> <span class="o">=</span> <span class="n">scan_for_expired_users</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">expired_users</span><span class="p">:</span>
        <span class="n">deactivating_process</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">send_expiration_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="n">task</span> <span class="o">=</span> <span class="n">PeriodicCallback</span><span class="p">(</span><span class="n">arda_task</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">30</span><span class="p">))</span>
<span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
</code></pre></div>

<h2>درباره‌ی jitter</h2>
<p>جیتر یک مفهوم ریاضی است  و برای کاهش  <code>alignment</code> رویدادهای با پریود مشابه استفاده می‌شود.</p>
<h4>بدون جیتر</h4>
<p><img alt="بدون جیتر" src="/images/1401/6/no-jitter-example.png"></p>
<h4>با جیتر</h4>
<p><img alt="بدون جیتر" src="/images/1401/6/jitter-example.png"></p>
<h4>اجرا با مقادیر متفاوت جیتر</h4>
<p><img alt="بدون جیتر" src="/images/1401/6/jitter.gif"></p>
<p>اگر مقدار جیتر را 0.1 قرار دهیم، باعث به‌ وجود آمدن تنوع 10 درصدی در فاصله زمانی فراخوانی کال‌بک خواهد شد.</p>
<h2>در آخر</h2>
<p>1- اگر اجرای کال‌بک بیشتر از <code>callback_time</code> طول بکشد، از فراخوانی‌های بعدی چشم‌پوشی می‌شود.«اضافه شده در تونادو 6.2»</p>
<p>2- چنان‌چه برای <code>alignment</code> معادلی مناسب یافتید، دریغ نکنید. tell.regnato[at]gmail.com</p>
<p>3- برای نکات جزیی‌تر می‌توانید مستندات تورنادو برای <a href="https://www.tornadoweb.org/en/stable/ioloop.html">PeriodicCallback</a> را چک کنید.</p>
<p>4- مثالی از اجرای همین تسک با Celery Beat را می‌توانید <a href="https://breadcrumbscollector.tech/what-is-celery-beat-and-how-to-use-it/">اینجا</a> بیابید.</p>
<p>5- عکس‌های مربوط به جیتر از <a href="https://www.myonlinetraininghub.com/jitter-in-excel-scatter-charts">اینجا</a> گرفته شده‌اند.</p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2022-08-31T10:20:00+04:30">Wed 31 August 2022</time>

            <h4>Category</h4>
            <a class="category-link" href="/categories.html#tornado-ref">Tornado</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="/tags.html#python-ref">python
                    <span class="superscript">1</span>
</a></li>
                <li><a href="/tags.html#tornado-ref">tornado
                    <span class="superscript">1</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/reganto/" title="Reganto Github" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://twitter.com/monaghizadeh" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="Twitter" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1da1f3"/><path fill="#fff" d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37"/></svg>
    </a>
    <a href="https://reganto.github.io/feeds/all.atom.xml" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="RSS" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#f80"/><circle cx="145" cy="367" r="35" fill="#fff"/><path fill="none" stroke="#fff" stroke-width="60" d="M109 241c89 0 162 73 162 162M109 127c152 0 276 124 276 276"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>
    <div>
        CC BY-SA 4.0
    </div>

    <div>
        <span class="site-name">رگانتو</span> - دست و دل نوشته‌های گیکی از وانیار
    </div>



    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>